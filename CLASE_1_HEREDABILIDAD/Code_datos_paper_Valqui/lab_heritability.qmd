---
title: "Heredabilidad en el fitomejoramiento"
author: "Flavio Lozano-Isla"
format:
  html:
    toc: true
    toc-location: left
    number-sections: true
    self-contained: true
editor_options: 
  chunk_output_type: console
execute:
  echo: false
  warning: false
---

```{r}
#| label: setup
#| include: false

source("https://inkaverse.com/docs.r")
knitr::opts_chunk$set(echo = T)

cran <- c("inti"
          , "metan"
          , "psych"
          , "FactoMineR"
          , "openxlsx"
          , "cowplot"
          )

suppressPackageStartupMessages({
  for (pkgs in cran) { 
    if( !require(pkgs, character.only = T) ) {
      install.packages(pkgs)
      library(pkgs, character.only = T)
    } 
  }
remove(cran, pkgs)
})
```

# Base de datos

```{r}
fb <- read.csv("QLB_2015.csv", sep = ";", header = TRUE)

# ?data_ge2

fb %>% web_table()

#CONVERTIR DATA Y ORDENAR A VALORES DE TIPO NUMÉRICO Y FACTOR
fb <- as_tibble(fb) %>% 
  mutate(
    Gen = as.factor(Gen),
    Location = as.factor(Location),
    Block = as.factor(Block),
    Plantheight = as.numeric(Plantheight),
    Seedyield = as.numeric(Seedyield),
    Seedyield_bio = as.numeric(Seedyield_bio),
    Biomass_bio = as.numeric(Biomass_bio),
    TKW_plot = as.numeric(TKW_plot),
    TKW_bio = as.numeric(TKW_bio),
    Spike_number = as.numeric(Spike_number),
    Sedimentation = as.numeric(Sedimentation),
    Falling_number = as.numeric(Falling_number),
    Crude_protein = as.numeric(Crude_protein)
  )
```

-   Revisar estructura de los datos

```{r}
#| eval: false

str(fb)
```

-   Estructura correcta, NO necesita transformación

# Base de datos en excel

```{r eval=FALSE}
openxlsx::write.xlsx(x = fb, file = "met.xlsx")

getwd()
```

> Directorio de trabajo `getwd()`

# Correlación de variables

```{r}
# browseURL("https://wilkelab.org/cowplot/articles/mixing_plot_frameworks.html")

png(filename = "correlation.png", width = 25, height = 25, units = "cm", res = 300)
fb %>%
  select(where(is.numeric))  %>% 
  pairs.panels(hist.col="red"
               , pch = 21
               , method = "pearson"
               , stars = T
               , scale = T
               , lm = T
               ) 
graphics.off()

include_graphics("correlation.png")
```

-   ¿Qué variables muestran correlaciones interesantes?

# Análisis multivariado

```{r}
mv <- fb %>% 
  group_by(Gen) %>% 
  summarise(across(where(is.numeric)
                   , ~ mean(.x, na.rm = TRUE))) %>%
  column_to_rownames("Gen") %>% 
  PCA(X = .
      , scale.unit = T
      , graph = F
          )
```

## Análisis de las variables

```{r}
plot1 <- plot.PCA(mv
                , choix = "var")

plot1
```

-   ¿Qué variables estan correlacionadas?

## Análisis de los individuos

```{r}
plot2 <- plot.PCA(mv
         , choix = "ind"
         , cex = 0.8
         , shadowtext = T
         , label = "ind"
         , autoLab = "yes"
         , graph.type = "ggplot"
         )

plot2
```

-   ¿Cuáles de los híbridos tuvieron mejores rendimientos?

```{r}
list(plot1, plot2) %>% 
  plot_grid(plotlist = .
            , nrow = 1
            , labels = "AUTO"
            , rel_widths = c(1, 1.5)
            )
```

# Heredabilidad

## Rendimiento

```{r}
length(unique(fb$Location))
hr <- H2cal(data = fb
            , trait = "Seedyield_bio"
            , gen.name = "Gen"
            , rep.n = 2
            , env.n = 1
            , fixed.model = "0 + (1|Block) + Gen"
            ,random.model = "1 + (1|Block) + (1|Gen)"
            , emmeans = TRUE
            , plot_diag = TRUE
            , outliers.rm = FALSE
            )
```

### Componentes de la variancia

```{r}
hr$model %>% summary()

hr$tabsmr %>% web_table()
```

### BLUPs

```{r}
hr$blups %>%
  arrange(desc(Seedyield_bio)) %>% 
  kable()
```

## Altura de planta

```{r}
hr2 <- H2cal(data = fb
            , trait = "Plantheight"
            , gen.name = "Gen"
            , rep.n = 2
            , env.n = 1
            , fixed.model = "0 + (1|Block) + Gen"
            ,random.model = "1 + (1|Block) + (1|Gen)"
            , emmeans = TRUE
            , plot_diag = TRUE
            , outliers.rm = FALSE
            )
```

### Componentes de la variancia

```{r}
hr2$model %>% summary()

hr2$tabsmr %>% web_table()
```

### BLUPs

```{r}
hr2$blups %>% 
  arrange(desc(Plantheight))
  kable()
```

# Eficiencia de uso de agua en Papa

```{r}
#| eval: false

browseURL("https://docs.google.com/spreadsheets/d/15r7ZwcZZHbEgltlF6gSFvCTFA-CFzVBWwg3mFlRyKPs/edit#gid=1263018298")
```

## Análisis interactivo

```{r}
#| eval: false

inti::yupana(dependencies = T)
```

-   Activar cuenta de google sheets
-   Datos en una hoja de Google sheets

# Plot grid

```{r}
library(dplyr)
library(cowplot)

list(plot1, plot2) %>% 
  plot_grid(plotlist = .
            , nrow = 1
            , labels = "AUTO"
            , rel_widths = c(1, 1.6)
            ) %>% 
  ggsave2("figures/quantitative-genetics.png", plot = .
          , width = 30, height = 12, units = "cm")
```

